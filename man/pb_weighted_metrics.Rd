% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/utils_weighted.R
\name{pb_weighted_metrics}
\alias{pb_weighted_metrics}
\title{Probability-weighted aggregation of polygon attributes given a probability surface}
\usage{
pb_weighted_metrics(
  bufferPoints.sf,
  polygons.sf,
  poly_id = "SPAID",
  weightVar = "layer",
  metrics
)
}
\arguments{
\item{bufferPoints.sf}{An `sf` object representing the probability surface for a single
displaced observation. Must contain a numeric column given by `weightVar` (default:
`"layer"`) that represents probability mass or relative weights.}

\item{polygons.sf}{An `sf` polygon layer containing polygon identifiers (`poly_id`) and
polygon-level attributes to be weighted (given by `metrics`).}

\item{poly_id}{Name of the polygon identifier column in `polygons.sf`. Defaults to
`"SPAID"`. The identifier is used only to aggregate weights and join polygon attributes.}

\item{weightVar}{Name of the weight/probability column in `bufferPoints.sf`. Defaults
to `"layer"`.}

\item{metrics}{Character vector of column names in `polygons.sf` giving the polygon-level
attributes to aggregate (e.g., readiness scores).}
}
\value{
A list with two elements:
\describe{
  \item{weightedMetrics.df}{A one-row `data.frame` with columns named by `metrics`,
  containing probability-weighted means of each metric.}
  \item{hfWeights}{A `data.frame` with columns `poly_id` (as named in `polygons.sf`) and
  `weight`, giving the normalized weight assigned to each polygon.}
}
}
\description{
Internal helper that computes probability-weighted summaries of polygon-level attributes
(e.g., facility readiness scores or other metrics) for a single displaced location.

The function intersects a set of probability-weighted geometries (typically points or
small polygons representing probability mass) with a polygon layer, aggregates the
probability mass to the polygon level, normalizes weights to sum to one, and then
returns weighted means of the requested polygon attributes.
}
\details{
**Intended use-case:** You have a displaced community location, you have already
generated a probability surface around that location (e.g., via `pb_Density()` /
`pb_integratedDensity()`), and you want a single best estimate of polygon attributes
under that uncertainty (plus the polygon-level weights used to construct it).

**Weighting logic:** Let \eqn{w_i} be the total probability mass intersecting polygon
\eqn{i}. The function normalizes these so that \eqn{\sum_i w_i = 1}, then for each
metric \eqn{m}, returns \eqn{\sum_i w_i m_i}. Normalization is deliberate: intersections
can drop mass when buffers extend beyond the polygon set, when polygons do not fully
cover the support of the probability surface, or when geometries are invalid.

**Failure modes:** The function errors if there are no intersections between the
probability layer and polygons (i.e., no basis to allocate mass).
}
\keyword{internal}
